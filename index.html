<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Quiz - Hist√≥ria do Acre</title>
  <meta name="theme-color" content="#2196f3">
  <link rel="manifest" href="manifest.json">
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0; padding: 0;
      background: url("fundo.jpg") no-repeat center center fixed;
      background-size: cover;
      position: relative;
      color: #023805;
    }
    body::before {
      content: "";
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: #9ff78c;
      z-index: -1;
    }
    header {
      background: #023805;
      color: #9ff78c;
      padding: 15px;
      text-align: center;
    }
    main { max-width: 800px; margin: auto; padding: 20px; }
    .tabs { display: flex; justify-content: center; margin-bottom: 20px; }
    .tabs button {
      flex: 1; padding: 10px; border: none;
      background: #9ff78c; cursor: pointer;
    }
    .tabs button.active { background: #023805; color: white; }
    .section { display: none; }
    .section.active { display: block; }
    .quiz-container, .editor {
      background: #9ff78c;
      padding: 20px; border-radius: 8px;
      box-shadow: 0 2px 6px #023805;
    }
    .question { margin-bottom: 15px; }
    .options button {
      display: block; margin: 5px 0; width: 100%;
      padding: 10px; border: none; border-radius: 5px;
      background: #9ff78c; cursor: pointer;
    }
    .options button.correct { background: #4caf50; color: white; }
    .options button.wrong { background: #e74c3c; color: white; }
    .next-btn {
      display: none; margin-top: 15px; padding: 10px 20px;
      background: #023805; color: #9ff78c; border: none;
      border-radius: 5px; cursor: pointer;
    }
    .editor input, .editor textarea {
      display: block; margin: 10px 0; padding: 8px; width: 100%;
    }
    .editor button {
      margin-top: 10px; padding: 10px; border: none;
      border-radius: 5px; background: #023805;
      color: #9ff78c; cursor: pointer;
    }
    .lesson-list { margin-top: 20px; }
    .lesson-list li {
      margin: 5px 0; background: #9ff78c;
      padding: 8px; border-radius: 5px;
    }
    .lesson-list button {
      margin-right: 5px; padding: 5px 8px; font-size: 12px;
      border: none; border-radius: 3px; cursor: pointer;
    }
    .edit-btn { background: #023805; color: white; }
    .delete-btn { background: #e74c3c; color: white; }
    #player-login, #admin-login {
      background: #9ff78c;
      padding: 20px; border-radius: 8px;
      margin-bottom: 20px; box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }
    #scoreboard { margin-top: 20px; background: #9ff78c; padding: 15px; border-radius: 8px; }
  </style>
</head>
<body>
  <header>
    <h1>Hist√≥ria do Acre - Quiz</h1>
  </header>
  <main>
    <!-- Login do jogador -->
    <div id="player-login">
      <h3>Bem-vindo ao Quiz!</h3>
      <input type="text" id="player-name" placeholder="Digite seu nome">
      <button id="start-quiz">Iniciar</button>
    </div>

    <!-- Tabs -->
    <div class="tabs">
      <button id="tab-quiz" class="active">Quiz</button>
      <button id="open-editor">Editor (Restrito)</button>
    </div>

    <!-- Login administrador -->
    <div id="admin-login" style="display:none;">
      <h3>√Årea restrita</h3>
      <input type="password" id="admin-pass" placeholder="Senha de administrador">
      <button id="check-pass">Entrar</button>
    </div>

    <!-- Quiz -->
    <section id="quiz-section" class="section active">
      <div class="quiz-container">
        <h2 id="lesson-title">Selecione uma aula</h2>
        <select id="lesson-select"></select>
        <div id="quiz"></div>
        <button class="next-btn" id="next-btn">Pr√≥xima Pergunta</button>
        <button id="show-scores">Ver Placar</button>
        <div id="scoreboard"></div>
      </div>
    </section>

    <!-- Editor -->
    <section id="editor-section" class="section">
      <div class="editor">
        <h2 id="form-title">Adicionar Pergunta</h2>
        <label>Aula:</label>
        <input type="text" id="lesson-input" placeholder="Ex: Aula 1">
        <label>Pergunta:</label>
        <textarea id="question-input"></textarea>
        <label>Op√ß√µes (separe por v√≠rgula):</label>
        <input type="text" id="options-input" placeholder="Op√ß√£o A, Op√ß√£o B, Op√ß√£o C">
        <label>Resposta correta:</label>
        <input type="text" id="answer-input">
        <button id="add-btn">Adicionar Pergunta</button>
        <button id="reload-questions" style="background:#00ff08;margin-left:5px;">üîÑ Recarregar da nuvem</button>
        <div class="lesson-list">
          <h3>Aulas j√° criadas:</h3>
          <div id="lesson-list"></div>
        </div>
      </div>
    </section>
  </main>

  <script>
    const ADMIN_PASSWORD = "04650465";

    function loadLessons() { return JSON.parse(localStorage.getItem("lessons")) || {}; }
    function saveLessons(data) { localStorage.setItem("lessons", JSON.stringify(data)); }

    let lessons = loadLessons();
    let currentLesson = null;
    let currentQuestionIndex = 0;
    let editing = null;
    let currentPlayer = null;
    let scores = JSON.parse(localStorage.getItem("scores")) || {};

    const quizEl = document.getElementById("quiz");
    const nextBtn = document.getElementById("next-btn");
    const lessonTitleEl = document.getElementById("lesson-title");
    const lessonSelectEl = document.getElementById("lesson-select");
    const lessonListEl = document.getElementById("lesson-list");
    const addBtn = document.getElementById("add-btn");
    const formTitle = document.getElementById("form-title");

    // === Carregar perguntas da nuvem
    async function fetchFromCloud() {
      try {
        const res = await fetch("perguntas.json");
        if (!res.ok) throw new Error("Erro ao carregar perguntas.json");
        const data = await res.json();
        lessons = data;
        saveLessons(lessons);
        renderLessonOptions();
        alert("Perguntas recarregadas da nuvem!");
      } catch (err) {
        console.error(err);
        alert("Erro ao buscar perguntas da nuvem.");
      }
    }

    async function initLessons() {
      if (Object.keys(lessons).length === 0) {
        await fetchFromCloud();
      } else {
        renderLessonOptions();
      }
    }

    // === Render
    function renderLessonOptions() {
      lessonSelectEl.innerHTML = "<option value=''>-- Escolha uma aula --</option>";
      Object.keys(lessons).forEach(lesson => {
        const opt = document.createElement("option");
        opt.value = lesson;
        opt.textContent = lesson;
        lessonSelectEl.appendChild(opt);
      });
      lessonListEl.innerHTML = "";
      Object.keys(lessons).forEach(lesson => {
        const div = document.createElement("div");
        div.innerHTML = `<h4>${lesson}</h4>`;
        const ul = document.createElement("ul");
        lessons[lesson].forEach((q, i) => {
          const li = document.createElement("li");
          li.innerHTML = `
            <strong>${i+1}. ${q.question}</strong><br>
            <small>Resposta: ${q.answer}</small>
            <div class="actions">
              <button class="edit-btn">Editar</button>
              <button class="delete-btn">Deletar</button>
            </div>
          `;
          li.querySelector(".edit-btn").addEventListener("click", () => {
            document.getElementById("lesson-input").value = lesson;
            document.getElementById("question-input").value = q.question;
            document.getElementById("options-input").value = q.options.join(", ");
            document.getElementById("answer-input").value = q.answer;
            editing = { lesson, index: i };
            formTitle.textContent = "Editar Pergunta";
            addBtn.textContent = "Salvar Altera√ß√µes";
          });
          li.querySelector(".delete-btn").addEventListener("click", () => {
            if (confirm("Deseja realmente deletar esta pergunta?")) {
              lessons[lesson].splice(i, 1);
              if (lessons[lesson].length === 0) delete lessons[lesson];
              saveLessons(lessons);
              renderLessonOptions();
            }
          });
          ul.appendChild(li);
        });
        div.appendChild(ul);
        lessonListEl.appendChild(div);
      });
    }

    // === Quiz
    function loadQuestion() {
      const questionObj = lessons[currentLesson][currentQuestionIndex];
      quizEl.innerHTML = `
        <div class="question"><strong>${questionObj.question}</strong></div>
        <div class="options">
          ${questionObj.options.map(opt => `<button>${opt}</button>`).join("")}
        </div>
      `;
      quizEl.querySelectorAll("button").forEach(btn => {
        btn.addEventListener("click", () => selectAnswer(btn, questionObj.answer));
      });
    }

    function selectAnswer(button, correctAnswer) {
      const buttons = quizEl.querySelectorAll("button");
      buttons.forEach(btn => {
        btn.disabled = true;
        if (btn.textContent.trim() === correctAnswer.trim()) {
          btn.classList.add("correct");
        } else if (btn === button) {
          btn.classList.add("wrong");
        }
      });
      if (currentPlayer) {
        if (button.textContent.trim() === correctAnswer.trim()) {
          scores[currentPlayer].acertos++;
        } else {
          scores[currentPlayer].erros++;
        }
        localStorage.setItem("scores", JSON.stringify(scores));
      }
      nextBtn.style.display = "block";
    }

    nextBtn.addEventListener("click", () => {
      currentQuestionIndex++;
      if (currentQuestionIndex < lessons[currentLesson].length) {
        loadQuestion();
        nextBtn.style.display = "none";
      } else {
        quizEl.innerHTML = "<h3>Fim da aula!</h3>";
        nextBtn.style.display = "none";
      }
    });

    lessonSelectEl.addEventListener("change", () => {
      currentLesson = lessonSelectEl.value;
      if (currentLesson) {
        currentQuestionIndex = 0;
        lessonTitleEl.textContent = currentLesson;
        loadQuestion();
        nextBtn.style.display = "none";
      } else {
        lessonTitleEl.textContent = "Selecione uma aula";
        quizEl.innerHTML = "";
      }
    });

    // === Admin adicionar
    addBtn.addEventListener("click", () => {
      const lesson = document.getElementById("lesson-input").value.trim();
      const question = document.getElementById("question-input").value.trim();
      const options = document.getElementById("options-input").value.split(",").map(o => o.trim());
      const answer = document.getElementById("answer-input").value.trim();
      if (!lesson || !question || options.length < 2 || !answer) {
        alert("Preencha todos os campos corretamente!");
        return;
      }
      if (editing) {
        lessons[editing.lesson][editing.index] = { question, options, answer };
        editing = null;
        formTitle.textContent = "Adicionar Pergunta";
        addBtn.textContent = "Adicionar Pergunta";
      } else {
        if (!lessons[lesson]) lessons[lesson] = [];
        lessons[lesson].push({ question, options, answer });
      }
      saveLessons(lessons);
      renderLessonOptions();
      document.getElementById("lesson-input").value = "";
      document.getElementById("question-input").value = "";
      document.getElementById("options-input").value = "";
      document.getElementById("answer-input").value = "";
    });

    // === Recarregar da nuvem (admin)
    document.getElementById("reload-questions").addEventListener("click", () => {
      if (confirm("Isso vai sobrescrever todas as perguntas locais. Continuar?")) {
        fetchFromCloud();
      }
    });

    // === Login jogador
    document.getElementById("start-quiz").addEventListener("click", () => {
      const name = document.getElementById("player-name").value.trim();
      if (!name) return alert("Digite seu nome!");
      currentPlayer = name;
      if (!scores[currentPlayer]) scores[currentPlayer] = { acertos: 0, erros: 0 };
      localStorage.setItem("scores", JSON.stringify(scores));
      document.getElementById("player-login").style.display = "none";
    });

    // === Ranking
    document.getElementById("show-scores").addEventListener("click", () => {
      let html = "<h3>Placar</h3><ul>";
      const ranking = Object.entries(scores).sort((a, b) => {
        if (b[1].acertos !== a[1].acertos) return b[1].acertos - a[1].acertos;
        return a[1].erros - b[1].erros;
      });
      ranking.forEach(([player, {acertos, erros}]) => {
        html += `<li><strong>${player}</strong> - ‚úÖ ${acertos} | ‚ùå ${erros}</li>`;
      });
      html += "</ul>";
      document.getElementById("scoreboard").innerHTML = html;
    });

    // === Tabs
    const tabQuiz = document.getElementById("tab-quiz");
    const openEditor = document.getElementById("open-editor");
    const quizSection = document.getElementById("quiz-section");
    const editorSection = document.getElementById("editor-section");

    tabQuiz.addEventListener("click", () => {
      tabQuiz.classList.add("active");
      editorSection.classList.remove("active");
      quizSection.classList.add("active");
    });
    openEditor.addEventListener("click", () => {
      document.getElementById("admin-login").style.display = "block";
    });
    document.getElementById("check-pass").addEventListener("click", () => {
      const pass = document.getElementById("admin-pass").value;
      if (pass === ADMIN_PASSWORD) {
        alert("Acesso liberado!");
        document.getElementById("admin-login").style.display = "none";
        editorSection.classList.add("active");
        quizSection.classList.remove("active");
      } else {
        alert("Senha incorreta!");
      }
    });

    // Inicializa√ß√£o
    initLessons();

    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("service-worker.js")
        .then(() => console.log("Service Worker ativo"))
        .catch(err => console.log("Erro SW", err));
    }
  </script>
</body>
</html>